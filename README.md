
<div align="center">

![:name](https://count.getloli.com/@astrbot_plugin_outputpro?name=astrbot_plugin_outputpro&theme=minecraft&padding=6&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

# astrbot_plugin_outputpro

_✨ 输出增强 ✨_  

[![License](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![AstrBot](https://img.shields.io/badge/AstrBot-3.4%2B-orange.svg)](https://github.com/Soulter/AstrBot)
[![GitHub](https://img.shields.io/badge/作者-Zhalslar-blue)](https://github.com/Zhalslar)

</div>

> ⚠️ **v2.1.0 起配置结构已调整**  
>
> - 阶梯统一由 `pipeline.steps` 控制  
> - 是否仅对 LLM 生效由 `pipeline.llm_steps` 控制  
> - 升级后请重新确认勾选需要启用的步骤

## 🤝 介绍

OutputPro 作用于 AstrBot **发送前**的“最后一公里”，把一条消息从原始文本到最终呈现拆成 12 个可独立开关的阶梯。  
阶梯顺序 = 配置里的 `pipeline.steps`，默认自上而下执行：

| 序号 | 阶梯 | 配置名 | 功能一句话 | 可关闭 | 仅 LLM |
|----|----|----|----|----|----|
| ① | 图片外显 | `summary` | 图片在群列表显示“金句” | ✅ | ❌ |
| ② | 报错处理 | `error` | 拦截 / 转发异常消息 | ✅ | ❌ |
| ③ | 消息拦截 | `block` | 官腔 / 复读 / 超时拦截 | ✅ | ✅ |
| ④ | 解析艾特 | `at` | 假 @ 转真 @，概率保留 | ✅ | ✅ |
| ⑤ | 文本清洗 | `clean` | 去括号 / emoji / 前后缀 | ✅ | ✅ |
| ⑥ | 文本替换 | `replace` | 敏感词替换 | ✅ | ✅ |
| ⑦ | 文转语音 | `tts` | QQ 声聊 TTS | ✅ | ✅ |
| ⑧ | 文转图片 | `t2i` | 长文转图（pillowmd） | ✅ | ✅ |
| ⑨ | 智能引用 | `reply` | 插嘴自动引用 | ✅ | ✅ |
| ⑩ | 合并转发 | `forward` | 超长转发 | ✅ | ❌ |
| ⑪ | 自动撤回 | `recall` | 关键词延迟撤回 | ✅ | ❌ |
| ⑫ | 分段回复 | `split` | 拆句 + 打字延迟 | ✅ | ✅ |

> 想改顺序？把 `pipeline.lock_order` 设成 `false`，然后 UI 拖拽即可。  
> 想让某一步只对 LLM 生效？在 `pipeline.llm_steps` 里勾选对应阶梯即可。

---

## 🧩 各阶梯说明

---

### ① 图片外显（summary）

单张图片在群列表中不再显示 `[图片]`，而是随机显示一句“金句”。  
用于提升群聊列表的可读性与趣味性。

**特性说明：**

- 仅在 **aiocqhttp** 平台可用
- 支持内置默认金句
- 支持加载多个外部金句文件
- 所有金句会合并后随机抽取一条

适合：整活、钓鱼、防止群列表全是 `[图片]`

---

### ② 报错处理（error）

全局拦截 Bot 即将发送的异常消息，避免将报错直接暴露给用户。

**触发条件：**

- 消息内容中包含任一“报错关键词”

**可执行操作：**

- 在原会话发送自定义提示消息（可留空）
- 将完整报错内容转发到：
  - 指定会话 ID
  - 或 `admin`（所有管理员）

适合：生产环境、避免用户看到模型或接口异常

---

### ③ 消息拦截（block）

核心输出净化模块，用于拦截不合适或无意义的回复。

**包含能力：**

- **超时拦截**  
  LLM 回复耗时超过设定秒数，直接丢弃，防止“回复错上下文”

- **复读拦截**  
  模型反复输出相同内容（流口水）时自动拦截

- **关键词拦截**  
  如“作为 AI 助手”“感谢您的理解”等典型官腔模板

通常仅对 **LLM 回复** 生效。

---

### ④ 解析艾特（at）

将句首手动输入的“假 @”解析为真正的 @ 消息，并按概率决定是否保留。

**行为逻辑：**

- 自动识别句首 `@昵称`
- 转换为平台支持的真 @
- 再根据概率决定：
  - 保留 @
  - 或移除 @

**概率说明：**

- `0` → 永不 @  
- `1` → 必定 @  
- `0.01` → 约 1% 概率 @

可选将真 @ 再转回字符串形式，解决空格被吞问题。

---

### ⑤ 文本清洗（clean）

对短文本进行“美容处理”，去掉多余结构与噪声。

**清洗顺序固定为：**

1. 中括号内容 `[...]`
2. 小括号内容 `(...)`（支持全角）
3. 情绪标签 `&&...&&`
4. emoji 表情
5. 句首多余字符
6. 句尾多余字符
7. 正则整体清洗特殊符号

**重要限制：**

- 仅当文本长度 ≤ 设定阈值时生效
- 用于避免对长文本或正文造成误伤

---

### ⑥ 文本替换（replace）

将消息中的特定词语替换为其他内容，常用于敏感词处理。

**规则格式：**
旧词 新词

- 未填写新词时，使用默认替换词
- 默认替换词可按旧词长度自动生成（如 `***`）

支持多条规则，按顺序执行。

---

### ⑦ 文转语音（tts）

将文本回复转为语音消息发送，基于 **QQ 官方声聊接口**。

**特点：**

- 无需部署服务
- 无需 API 密钥
- 多种语音角色可选
- 按概率触发
- 超长文本自动跳过

**使用前注意：**

- 必须填写一个“中转群群号”
- 请关闭 AstrBot 自带的 TTS 功能

---

### ⑧ 文转图片（t2i）

当文本过长时，自动将内容渲染为图片发送。

**实现方式：**

- 使用 `pillowmd` 进行轻量渲染
- 本地生成，无网络依赖

**支持功能：**

- 文本长度阈值控制
- 自定义样式目录
- 黄金分割比例自动分页
- 插件重载时自动清理缓存

---

### ⑨ 智能引用（reply）

当 Bot 准备回复的消息被其他人插嘴时，自动引用原消息。

**触发条件：**

- 原消息在 Bot 回复前，被插入 ≥ N 条新消息

**说明：**

- `threshold = 0` 表示完全关闭
- 使用前请关闭 AstrBot 自带的 Reply 功能

用于防止多人活跃群中上下文错位。

---

### ⑩ 合并转发（forward）

当文本仍然过长时，自动转为合并转发消息。

**特性：**

- 支持自定义转发节点昵称
- 留空则使用 Bot 当前昵称
- 仅 **aiocqhttp** 平台可用

适合发送日志、长说明、长列表。

---

### ⑪ 自动撤回（recall）

检测到包含特定关键词的消息后，延迟撤回。

**典型用途：**

- 防止误发隐私信息
- 防止测试内容残留在群内

**行为：**

- 命中关键词
- 等待设定秒数
- 自动撤回消息

仅对已成功发送的消息生效。

---

### ⑫ 分段回复（split）

将一条长消息拆分为多条，分批发送，模拟真人打字节奏。

**支持能力：**

- 按指定符号分段（如 `。？！\n`）
- 智能分段（成对符号内部不拆）
- 最大分段数量限制
- 动态打字延迟（短文本快，长文本慢）

适合闲聊、角色扮演、增强拟人感。

---

### 📎 跨阶梯通用规则

1. 任一阶梯返回“拦截”后，后续阶梯将不再执行  
2. 被标记为 **仅 LLM 生效** 的阶梯，不会处理普通插件消息  
3. 合理配置 `llm_steps` 可显著降低性能开销

---

### 附：跨阶梯通用规则

1. 仅对 LLM 生效的阶梯已在 `pipeline.llm_steps` 默认勾选，普通插件消息会直接跳过这些步骤，节省性能。  
2. 任何阶梯返回“拦截”后，后续步骤立即终止，消息不会发出。

---

## 📦 安装

在astrbot的插件市场搜索astrbot_plugin_outputpro，点击安装即可

## ⌨️ 使用说明

请前往配置中查看

### 示例图

## 👥 贡献指南

- 🌟 Star 这个项目！（点右上角的星星，感谢支持！）
- 🐛 提交 Issue 报告问题
- 💡 提出新功能建议
- 🔧 提交 Pull Request 改进代码

## 📌 注意事项

- 想第一时间得到反馈的可以来作者的插件反馈群（QQ群）：460973561（不点star不给进）
